import sys
from os.path import dirname, abspath
from os.path import join as join_path

try:
    from git import Repo
except ImportError:
    print('[FAILURE]: gitpython not installed. pip install gitpython')
    exit(1)


class CommitMsg(object):
    def __init__(self, coauthors):
        githooks_dir = dirname(abspath(__file__))
        self._repo_path = dirname(dirname(githooks_dir))
        self.repo = Repo(self._repo_path)
        self._authors_file = join_path(dirname(githooks_dir), 'authors.lst')
        self._coauthors = coauthors.split(',')
        self.no_coauthors = (self._coauthors[0] == '')

    def read_authors_file(self):
        try:
            if not exists(self._authors_file):  raise IOError
            contents = open(self._authors_file, 'r').readlines()
            authors = [x.split(':') for x in contents]
            return dict(authors)
        except IOError:
            print('authors.lst not found, check README!')
            sys.exit(1)

    def get_coauthor_details(self):
        contents = open(self._authors_file, 'r').readlines()
        authors = [x.split(':') for x in contents]
        return dict(authors)

    def get_coauthor_name_email(self):
        coauth_info = self.get_coauthor_details()
        return [coauth_info[x.strip().upper()].split(',') for x in self._coauthors]

    @property
    def co_authors(self):
        if self.no_coauthors:
            return '\n'
        else:
            prefix_str = 'Co-authored-by: {}'
            _coauth_fmt = lambda x: x[0].strip() + ' <' + x[1].strip() + '@superhero.universe>'

            coauths_lst = self.get_coauthor_name_email()
            coauths_str = [prefix_str.format(_coauth_fmt(x)) for x in coauths_lst]
            # git expects co-authors after two blank lines
            return '\n\n' + '\n'.join(coauths_str) + '\n\n'


def get_coauthor_initials():
    sys.stdin = open('/dev/tty', 'r')
    coauthors = raw_input(
        "\n[INFO]: ADD co-authors (if any) as a comma separated list of 2 letter initials.\n\texample input - ts, gs (for Tony Stark and Pt. Gangadhar Shastri)\n\t Open ../authors.lst to view the current list of authors for this project\n\n[INPUT]: Enter co-author(s) initials: ")
    return coauthors


def prepare_message(commit_msg_filepath, auths):
    """
    prepares the message in the format:

    commit summary

    <empty body>


    Co-authored-by: A B <A.B@company.domain>

    # comments
    """
    commit_msg = CommitMsg(auths)

    with open(commit_msg_filepath, 'r+') as f:
        msg = f.readlines()
        f.seek(0, 0)
        # first line of variable msg is already filled if git commit -m "<msg>" is executed
        f.write("{}{}{}".format(msg[0], commit_msg.co_authors, ''.join(msg[1:])))


if __name__ == '__main__':
    commit_msg_filepath = sys.argv[1]
    commit_type = sys.argv[2] if len(sys.argv) > 2 else ''

    # execute only for message commit type. For amend, merge, squash simply exit
    if commit_type not in ['', 'message']:
        sys.exit(0)

    coauthors = get_coauthor_initials()
    prepare_message(commit_msg_filepath, coauthors)
